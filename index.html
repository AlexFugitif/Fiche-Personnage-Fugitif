<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Vos balises head inchangées -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Fiche de Personnage - Le Fugitif</title>
    <style>
        /* Vos styles CSS inchangés */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #0a0a0f;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }
        /* ... le reste de vos styles ... */
    </style>
</head>
<body>
    <!-- Votre contenu HTML inchangé -->
    <div class="fiche">
        <h1>Fiche de Personnage</h1>
        <h2>Le Fugitif - Polarpunk Uchronie</h2>
        <!-- ... le reste de votre contenu ... -->
    </div>

    <!-- Bouton pour générer le PDF -->
    <button id="generate-pdf" style="margin-top: 20px; padding: 10px 20px; font-size: 16px; display: block; margin: 20px auto; background-color: #00b3ff; color: white; border: none; border-radius: 5px; cursor: pointer;">Générer le PDF</button>

    <!-- Inclusion des bibliothèques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <!-- Votre code JavaScript -->
    <script>
        function triggerUpload(slotIndex) {
            const slot = document.querySelectorAll('.slot, .image-preview')[slotIndex];
            const input = slot.querySelector('input');
            input.click();
        }

        function previewImage(event) {
            const preview = document.querySelector('.image-preview');
            const file = event.target.files[0];
            if (file) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => URL.revokeObjectURL(img.src);
                preview.innerHTML = '';
                preview.appendChild(img);
            }
        }

        function previewSlot(event, slotIndex) {
            const slot = document.querySelectorAll('.slot')[slotIndex - 1];
            const file = event.target.files[0];
            if (file) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => URL.revokeObjectURL(img.src);
                slot.innerHTML = '';
                slot.appendChild(img);
            }
        }

        function waitForImagesToLoad(element) {
            const images = element.querySelectorAll('img');
            return Promise.all(Array.from(images).map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve;
                });
            }));
        }

        document.getElementById('generate-pdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;

            const fiche = document.querySelector('.fiche');

            const options = {
                scale: 3, // Résolution améliorée
                useCORS: true // Capturer les images locales
            };

            waitForImagesToLoad(fiche).then(() => {
                html2canvas(fiche, options).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');

                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    const imgWidth = pdfWidth;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);

                    // Si le contenu dépasse une page
                    while (imgHeight > pdfHeight) {
                        position -= pdfHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        imgHeight -= pdfHeight;
                    }

                    pdf.save('fiche_personnage.pdf');
                }).catch(error => {
                    alert('Erreur lors de la génération du PDF : ' + error.message);
                });
            });
        });
    </script>
</body>
</html>
