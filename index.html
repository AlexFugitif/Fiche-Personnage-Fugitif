<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- ... (votre code head inchangé) ... -->
    <!-- Inclusion des bibliothèques nécessaires -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- ... (votre contenu HTML inchangé) ... -->

    <!-- Bouton pour générer le PDF -->
    <button id="generate-pdf" style="margin-top: 20px; padding: 10px 20px; font-size: 16px; display: block; margin: 20px auto; background-color: #00b3ff; color: white; border: none; border-radius: 5px; cursor: pointer;">Générer le PDF</button>

    <!-- Votre code JavaScript -->
    <script>
        // ... (vos fonctions previewImage, deleteImage, etc.) ...

        // Fonction pour attendre le chargement des images
        function waitForImagesToLoad(element) {
            const images = element.querySelectorAll('img');
            const promises = [];
            images.forEach((img) => {
                if (!img.complete) {
                    promises.push(new Promise((resolve) => {
                        img.onload = img.onerror = resolve;
                    }));
                }
            });
            return Promise.all(promises);
        }

        // Gestion de la génération du PDF
        document.getElementById('generate-pdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;

            const fiche = document.querySelector('.fiche');

            waitForImagesToLoad(fiche).then(() => {
                html2canvas(fiche, { scale: 2, useCORS: true }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');

                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    const imgWidth = pdfWidth;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pdfHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pdfHeight;
                    }

                    pdf.save('fiche_personnage.pdf');
                }).catch(error => {
                    alert('Erreur lors de la génération du PDF : ' + error.message);
                });
            });
        });
    </script>
</body>
</html>
